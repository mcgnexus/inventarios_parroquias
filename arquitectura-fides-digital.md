# ARQUITECTURA COMPLETA DE FIDES DIGITAL - MAPA DE DATOS Y CONEXIONES

## üóÑÔ∏è MODELO DE DATOS COMPLETO

### **1. TABLA: `parishes` (Parroquias)**
**Prop√≥sito:** Entidad principal que agrupa todos los datos de una parroquia

| Campo | Tipo | Descripci√≥n | Relaciones |
|-------|------|-------------|------------|
| `id` | UUID (PK) | Identificador √∫nico | ‚Üí `profiles.parish_id`, `items.parish_id`, `subscriptions.parish_id` |
| `name` | TEXT | Nombre de la parroquia | - |
| `diocese` | TEXT | Di√≥cesis a la que pertenece | - |
| `location` | TEXT | Ciudad/pueblo | - |
| `address` | TEXT | Direcci√≥n postal | - |
| `email` | TEXT | Email de contacto | - |
| `phone` | TEXT | Tel√©fono | - |
| `admin_user_id` | UUID (FK) | Usuario administrador principal | ‚Üí `profiles.id` |
| `created_at` | TIMESTAMPTZ | Fecha de creaci√≥n | Auto |
| `updated_at` | TIMESTAMPTZ | √öltima actualizaci√≥n | Auto (trigger) |

**√çndices:**
- PK en `id`
- Index en `admin_user_id`

---

### **2. TABLA: `profiles` (Usuarios)**
**Prop√≥sito:** Perfiles de usuarios vinculados a Supabase Auth

| Campo | Tipo | Descripci√≥n | Relaciones |
|-------|------|-------------|------------|
| `id` | UUID (PK) | Mismo ID que `auth.users` | ‚Üê `parishes.admin_user_id`, ‚Üí `items.created_by`, `media.uploaded_by` |
| `full_name` | TEXT | Nombre completo | - |
| `email` | TEXT | Email (sincronizado con auth.users) | - |
| `role` | TEXT | Rol del usuario | Valores: `admin`, `user`, `viewer` |
| `parish_id` | UUID (FK) | Parroquia a la que pertenece | ‚Üê `parishes.id` |
| `created_at` | TIMESTAMPTZ | Fecha de creaci√≥n | Auto |
| `updated_at` | TIMESTAMPTZ | √öltima actualizaci√≥n | Auto (trigger) |

**√çndices:**
- PK en `id`
- Index en `parish_id`
- Index en `email`

**L√≥gica de roles:**
- **admin:** Puede crear, editar, eliminar objetos y usuarios
- **user:** Puede crear y editar objetos
- **viewer:** Solo lectura

---

### **3. TABLA: `items` (Objetos del inventario)**
**Prop√≥sito:** Registro individual de cada pieza patrimonial

| Campo | Tipo | Descripci√≥n | Relaciones |
|-------|------|-------------|------------|
| `id` | UUID (PK) | Identificador √∫nico | ‚Üí `media.item_id` |
| `parish_id` | UUID (FK) | Parroquia propietaria | ‚Üê `parishes.id` |
| `created_by` | UUID (FK) | Usuario que cre√≥ el registro | ‚Üê `profiles.id` |
| `name` | TEXT | Nombre del objeto | Searchable |
| `inventory_number` | TEXT | C√≥digo/n√∫mero de inventario | √önico por parroquia |
| `category` | TEXT | Categor√≠a del objeto | Valores: `orfebreria`, `ornamento_liturgico`, `imagineria`, `pintura`, `escultura`, `mobiliario`, `documento`, `libro`, `textil`, `otro` |
| `description_brief` | TEXT | Descripci√≥n corta (m√°x 200 chars) | Searchable |
| `description_detailed` | TEXT | Descripci√≥n completa | Searchable |
| `materials` | TEXT[] | Array de materiales | Ej: `["plata", "madera dorada"]` |
| `techniques` | TEXT[] | T√©cnicas art√≠sticas | Ej: `["cincelado", "repujado"]` |
| `artistic_style` | TEXT | Estilo art√≠stico | Ej: "Barroco", "G√≥tico" |
| `dating_approximate` | TEXT | Dataci√≥n aproximada | Ej: "Mediados del siglo XVII" |
| `centuries_estimated` | TEXT | Siglos estimados | Ej: "XVII-XVIII" |
| `iconography` | TEXT | Descripci√≥n iconogr√°fica | Searchable |
| `conservation_state` | TEXT | Estado de conservaci√≥n | Valores: `excelente`, `bueno`, `regular`, `deficiente`, `critico` |
| `visible_damage` | TEXT[] | Da√±os visibles | Ej: `["oxidaci√≥n leve", "falta de dorado"]` |
| `location` | TEXT | Ubicaci√≥n dentro de la parroquia | Ej: "Sacrist√≠a, armario 2" |
| `artistic_value` | TEXT | Valor art√≠stico estimado | Valores: `muy_alto`, `alto`, `medio`, `regular`, `bajo` |
| `review_json` | JSONB | Propuesta completa de la IA | JSON estructurado de Dify |
| `ai_confidence` | TEXT | Confianza del an√°lisis IA | Valores: `alta`, `media`, `baja` |
| `analyzed_at` | TIMESTAMPTZ | Fecha de an√°lisis IA | Nullable |
| `status` | TEXT | Estado del registro | Valores: `draft`, `ai_suggested`, `validated`, `published` |
| `created_at` | TIMESTAMPTZ | Fecha de creaci√≥n | Auto |
| `updated_at` | TIMESTAMPTZ | √öltima actualizaci√≥n | Auto (trigger) |
| `published_at` | TIMESTAMPTZ | Fecha de publicaci√≥n | Nullable |

**√çndices:**
- PK en `id`
- Index en `parish_id`
- Index en `created_by`
- Index compuesto en `(parish_id, status)`
- Index compuesto en `(parish_id, category)`
- Index GIN en `materials` (b√∫squeda en arrays)
- Index GIN en `techniques` (b√∫squeda en arrays)
- Index GIN en `visible_damage` (b√∫squeda en arrays)
- **Full-text search index** en espa√±ol sobre `name || ' ' || description_brief || ' ' || description_detailed || ' ' || iconography`

**Flujo de estados:**
1. `draft` ‚Üí Usuario crea objeto manualmente sin IA
2. `ai_suggested` ‚Üí IA ha analizado imagen y propuesto catalogaci√≥n
3. `validated` ‚Üí Usuario ha revisado y aprobado propuesta IA
4. `published` ‚Üí Objeto finalizado y visible en inventario

---

### **4. TABLA: `media` (Archivos multimedia)**
**Prop√≥sito:** Gesti√≥n de im√°genes y archivos adjuntos

| Campo | Tipo | Descripci√≥n | Relaciones |
|-------|------|-------------|------------|
| `id` | UUID (PK) | Identificador √∫nico | - |
| `item_id` | UUID (FK) | Objeto al que pertenece | ‚Üê `items.id` (CASCADE DELETE) |
| `file_name` | TEXT | Nombre original del archivo | - |
| `file_type` | TEXT | MIME type | Ej: `image/jpeg`, `image/png` |
| `storage_path` | TEXT | Ruta en Supabase Storage | Ej: `items/{parish_id}/{item_id}/{timestamp}_{filename}` |
| `public_url` | TEXT | URL p√∫blica firmada | Generada por Supabase |
| `media_type` | TEXT | Tipo de medio | Valores: `photo`, `document`, `video`, `other` |
| `width` | INTEGER | Ancho en p√≠xeles | Nullable |
| `height` | INTEGER | Alto en p√≠xeles | Nullable |
| `display_order` | INTEGER | Orden de visualizaci√≥n | Default: 0 |
| `is_primary` | BOOLEAN | ¬øEs la imagen principal? | Solo una por `item_id` (trigger) |
| `caption` | TEXT | Descripci√≥n/pie de foto | Nullable |
| `uploaded_by` | UUID (FK) | Usuario que subi√≥ el archivo | ‚Üê `profiles.id` |
| `created_at` | TIMESTAMPTZ | Fecha de subida | Auto |

**√çndices:**
- PK en `id`
- Index en `item_id`
- Index compuesto en `(item_id, is_primary)` (para buscar imagen principal r√°pido)
- Index en `uploaded_by`

**Trigger especial:**
- Al marcar `is_primary = true`, autom√°ticamente desmarca otras fotos del mismo item

**Estructura en Storage:**
```
bucket: inventario/
‚îî‚îÄ‚îÄ items/
    ‚îî‚îÄ‚îÄ {parish_id}/
        ‚îî‚îÄ‚îÄ {item_id}/
            ‚îú‚îÄ‚îÄ 1234567890_foto1.jpg
            ‚îú‚îÄ‚îÄ 1234567891_foto2.jpg
            ‚îî‚îÄ‚îÄ 1234567892_detalle.jpg
```

---

### **5. TABLA: `subscriptions` (Suscripciones)**
**Prop√≥sito:** Control de planes y l√≠mites de uso

| Campo | Tipo | Descripci√≥n | Relaciones |
|-------|------|-------------|------------|
| `id` | UUID (PK) | Identificador √∫nico | - |
| `parish_id` | UUID (FK) | Parroquia suscrita | ‚Üê `parishes.id` (UNIQUE) |
| `plan` | TEXT | Plan contratado | Valores: `free`, `basic`, `premium` |
| `status` | TEXT | Estado de la suscripci√≥n | Valores: `active`, `canceled`, `past_due`, `trialing` |
| `max_items` | INTEGER | L√≠mite de objetos | `free`: 20, `basic`: NULL, `premium`: NULL |
| `max_ai_analyses` | INTEGER | An√°lisis IA por mes | `free`: 10, `basic`: 50, `premium`: NULL |
| `ai_analyses_used` | INTEGER | An√°lisis usados en periodo actual | Resetea cada mes |
| `stripe_customer_id` | TEXT | ID en Stripe | Nullable |
| `stripe_subscription_id` | TEXT | ID de suscripci√≥n en Stripe | Nullable |
| `current_period_start` | TIMESTAMPTZ | Inicio del periodo actual | - |
| `current_period_end` | TIMESTAMPTZ | Fin del periodo actual | - |
| `created_at` | TIMESTAMPTZ | Fecha de creaci√≥n | Auto |
| `updated_at` | TIMESTAMPTZ | √öltima actualizaci√≥n | Auto (trigger) |

**√çndices:**
- PK en `id`
- Index UNIQUE en `parish_id`
- Index en `stripe_customer_id`
- Index en `stripe_subscription_id`

**L√≠mites por plan:**

| Plan | Max Items | Max AI/mes | Precio |
|------|-----------|------------|--------|
| **FREE** | 20 | 10 | ‚Ç¨0 |
| **BASIC** | ‚àû | 50 | ‚Ç¨9.99/mes |
| **PREMIUM** | ‚àû | ‚àû | ‚Ç¨19.99/mes |

---

## üîó MAPA DE RELACIONES

```
auth.users (Supabase Auth)
    ‚Üì 1:1
profiles
    ‚îú‚îÄ‚îÄ parish_id ‚Üí parishes
    ‚îî‚îÄ‚îÄ id ‚Üê parishes.admin_user_id
              ‚Üë
              ‚îÇ parish_id
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ         ‚îÇ              ‚îÇ
      items   subscriptions   profiles (otros usuarios)
         ‚îú‚îÄ‚îÄ created_by ‚Üí profiles
         ‚îî‚îÄ‚îÄ id ‚Üí media.item_id
                      ‚îî‚îÄ‚îÄ uploaded_by ‚Üí profiles
```

### **Relaciones detalladas:**

1. **`auth.users` ‚Üí `profiles`** (1:1)
   - Cada usuario autenticado tiene un perfil
   - `profiles.id` = `auth.users.id`

2. **`parishes` ‚Üî `profiles`** (1:N)
   - Una parroquia tiene m√∫ltiples usuarios
   - `profiles.parish_id` ‚Üí `parishes.id`
   - Una parroquia tiene un admin principal
   - `parishes.admin_user_id` ‚Üí `profiles.id`

3. **`parishes` ‚Üí `items`** (1:N)
   - Una parroquia tiene m√∫ltiples objetos
   - `items.parish_id` ‚Üí `parishes.id`
   - **RLS:** Usuarios solo ven items de su parroquia

4. **`profiles` ‚Üí `items`** (1:N)
   - Un usuario crea m√∫ltiples objetos
   - `items.created_by` ‚Üí `profiles.id`

5. **`items` ‚Üí `media`** (1:N)
   - Un objeto tiene m√∫ltiples fotos/archivos
   - `media.item_id` ‚Üí `items.id`
   - **Cascade delete:** Al borrar item, se borran sus fotos

6. **`profiles` ‚Üí `media`** (1:N)
   - Un usuario sube m√∫ltiples archivos
   - `media.uploaded_by` ‚Üí `profiles.id`

7. **`parishes` ‚Üí `subscriptions`** (1:1)
   - Una parroquia tiene una suscripci√≥n
   - `subscriptions.parish_id` ‚Üí `parishes.id` (UNIQUE)

---

## üîí ROW LEVEL SECURITY (RLS)

### **Pol√≠tica general para todas las tablas:**
```sql
-- SELECT: Solo datos de tu parroquia
CREATE POLICY "Users see only their parish data"
ON table_name FOR SELECT
USING (parish_id = (SELECT parish_id FROM profiles WHERE id = auth.uid()));

-- INSERT: Solo en tu parroquia
CREATE POLICY "Users insert only in their parish"
ON table_name FOR INSERT
WITH CHECK (parish_id = (SELECT parish_id FROM profiles WHERE id = auth.uid()));

-- UPDATE: Solo admins y users
CREATE POLICY "Admins and users can update"
ON table_name FOR UPDATE
USING (
  parish_id = (SELECT parish_id FROM profiles WHERE id = auth.uid())
  AND (SELECT role FROM profiles WHERE id = auth.uid()) IN ('admin', 'user')
);

-- DELETE: Solo admins
CREATE POLICY "Only admins can delete"
ON table_name FOR DELETE
USING (
  parish_id = (SELECT parish_id FROM profiles WHERE id = auth.uid())
  AND (SELECT role FROM profiles WHERE id = auth.uid()) = 'admin'
);
```

### **Pol√≠ticas especiales:**

**`profiles`:**
- SELECT: Ver todos los usuarios de tu parroquia
- UPDATE: Solo admins pueden cambiar roles

**`media`:**
- SELECT: Ver fotos de objetos de tu parroquia (join con items)
- DELETE: Solo admins o el usuario que subi√≥ la foto

**`subscriptions`:**
- SELECT: Solo admins ven los datos de suscripci√≥n
- UPDATE/DELETE: Solo service role (webhooks de Stripe)

**Storage bucket `inventario`:**
- SELECT: P√∫blico (cualquiera con URL puede ver)
- INSERT: Solo usuarios autenticados
- UPDATE: Solo usuarios autenticados
- DELETE: Solo admins

---

## üîß FUNCIONES POSTGRESQL PERSONALIZADAS

### **1. `check_item_limit(p_parish_id UUID)`**
**Prop√≥sito:** Verificar si una parroquia puede a√±adir m√°s objetos

```sql
RETURNS BOOLEAN
```

**L√≥gica:**
1. Obtiene el plan actual de `subscriptions`
2. Si plan = `free`, cuenta items existentes
3. Retorna `false` si ya alcanz√≥ l√≠mite (20)
4. Retorna `true` si puede a√±adir m√°s

**Uso en aplicaci√≥n:**
- Antes de INSERT en `items`, llamar esta funci√≥n
- Si retorna `false`, mostrar mensaje "Upgrade plan"

---

### **2. `increment_ai_usage(p_parish_id UUID)`**
**Prop√≥sito:** Registrar uso de an√°lisis IA

```sql
RETURNS VOID
```

**L√≥gica:**
1. Incrementa `ai_analyses_used` en `subscriptions`
2. Si alcanza l√≠mite (`max_ai_analyses`), lanza excepci√≥n
3. Resetea contador si el periodo ha expirado

**Uso en aplicaci√≥n:**
- Despu√©s de llamar a Dify, ejecutar esta funci√≥n
- Si lanza excepci√≥n, mostrar "L√≠mite alcanzado"

---

### **3. `get_parish_stats(p_parish_id UUID)`**
**Prop√≥sito:** Obtener estad√≠sticas completas de una parroquia

```sql
RETURNS JSON
```

**Retorna:**
```json
{
  "total_items": 150,
  "items_by_category": {
    "orfebreria": 25,
    "imagineria": 40,
    "ornamento_liturgico": 30
  },
  "items_by_status": {
    "draft": 5,
    "ai_suggested": 10,
    "validated": 50,
    "published": 85
  },
  "conservation_summary": {
    "excelente": 20,
    "bueno": 80,
    "regular": 40,
    "deficiente": 8,
    "critico": 2
  },
  "subscription": {
    "plan": "basic",
    "items_used": 150,
    "items_limit": null,
    "ai_used": 35,
    "ai_limit": 50
  }
}
```

**Uso en aplicaci√≥n:**
- Dashboard principal
- Gr√°ficos y KPIs

---

### **4. `search_items(...)`**
**Prop√≥sito:** B√∫squeda avanzada con full-text y filtros

```sql
search_items(
  p_parish_id UUID,
  p_query TEXT DEFAULT NULL,
  p_category TEXT DEFAULT NULL,
  p_status TEXT DEFAULT NULL,
  p_conservation TEXT DEFAULT NULL,
  p_limit INTEGER DEFAULT 20,
  p_offset INTEGER DEFAULT 0
)
RETURNS SETOF items
```

**L√≥gica:**
1. Full-text search en espa√±ol sobre nombre, descripci√≥n, iconograf√≠a
2. Filtros opcionales por categor√≠a, estado, conservaci√≥n
3. Ordenado por relevancia (ts_rank)
4. Paginaci√≥n con LIMIT/OFFSET

**Uso en aplicaci√≥n:**
- Barra de b√∫squeda del inventario
- Filtros avanzados

---

### **5. `delete_item_complete(p_item_id UUID)`**
**Prop√≥sito:** Eliminaci√≥n completa con limpieza de archivos

```sql
RETURNS VOID
```

**L√≥gica:**
1. Verifica permisos (solo admin)
2. Obtiene paths de archivos en Storage de `media`
3. Borra registros de `media` (trigger cascade)
4. Borra archivos f√≠sicos en Storage
5. Borra registro de `items`

**Uso en aplicaci√≥n:**
- Bot√≥n "Eliminar" en detalle de objeto
- Confirmaci√≥n de eliminaci√≥n

---

## üìä VISTAS PREDEFINIDAS

### **1. Vista: `items_with_media`**
```sql
SELECT 
  i.*,
  m.public_url as primary_image_url,
  m.file_name as primary_image_name
FROM items i
LEFT JOIN media m ON i.id = m.item_id AND m.is_primary = true;
```

**Uso:** Lista de objetos con imagen principal

---

### **2. Vista: `items_complete`**
```sql
SELECT 
  i.*,
  p.name as parish_name,
  p.diocese,
  pr.full_name as created_by_name,
  COALESCE(
    json_agg(
      json_build_object(
        'id', m.id,
        'url', m.public_url,
        'type', m.media_type,
        'is_primary', m.is_primary
      )
      ORDER BY m.is_primary DESC, m.display_order
    ) FILTER (WHERE m.id IS NOT NULL),
    '[]'
  ) as media_files
FROM items i
JOIN parishes p ON i.parish_id = p.id
JOIN profiles pr ON i.created_by = pr.id
LEFT JOIN media m ON i.item_id = m.item_id
GROUP BY i.id, p.id, pr.id;
```

**Uso:** Detalle completo de objeto con todas sus relaciones

---

### **3. Vista: `parish_usage`**
```sql
SELECT 
  p.id as parish_id,
  p.name as parish_name,
  s.plan,
  s.status,
  COUNT(i.id) as items_count,
  s.max_items as items_limit,
  s.ai_analyses_used,
  s.max_ai_analyses as ai_limit,
  CASE 
    WHEN s.max_items IS NULL THEN NULL
    ELSE (COUNT(i.id)::FLOAT / s.max_items * 100)
  END as items_usage_percent
FROM parishes p
JOIN subscriptions s ON p.id = s.parish_id
LEFT JOIN items i ON p.id = i.parish_id
GROUP BY p.id, s.id;
```

**Uso:** Monitoreo de uso de l√≠mites por plan

---

## ü§ñ INTEGRACI√ìN CON DIFY (IA)

### **Flujo de an√°lisis IA:**

```
1. Usuario sube imagen ‚Üí Supabase Storage
                          ‚Üì
2. Frontend obtiene public_url
                          ‚Üì
3. POST /api/catalog/analyze
   Body: { imageUrl, itemId }
                          ‚Üì
4. Next.js API Route:
   - Llama a Dify API
   - Env√≠a imagen + prompt
   - Recibe JSON estructurado
                          ‚Üì
5. Validaci√≥n con Zod:
   - Verifica estructura
   - Sanitiza datos
                          ‚Üì
6. Guarda en Supabase:
   UPDATE items SET
     review_json = {...},
     analyzed_at = NOW(),
     status = 'ai_suggested',
     ai_confidence = 'alta|media|baja'
                          ‚Üì
7. Frontend muestra propuesta
   (Doble columna: IA ‚Üî Usuario)
                          ‚Üì
8. Usuario revisa y aprueba
                          ‚Üì
9. PUT /api/items/{id}/validate
   - Copia campos de review_json a campos definitivos
   - Actualiza status = 'validated'
   - Incrementa ai_analyses_used
```

### **Estructura del JSON de la IA (`review_json`):**

```json
{
  "tipo_objeto": "C√°liz",
  "categoria": "orfebreria",
  "descripcion_breve": "C√°liz de plata sobredorada con decoraci√≥n barroca",
  "descripcion_detallada": "Pieza de plata de ley...",
  "materiales": ["plata", "oro", "esmalte"],
  "tecnicas": ["cincelado", "repujado", "esmaltado"],
  "estilo_artistico": "Barroco",
  "datacion_aproximada": "Segunda mitad del siglo XVII",
  "siglos_estimados": "XVII",
  "iconografia": "Motivos vegetales, querubines...",
  "estado_conservacion": "bueno",
  "deterioros_visibles": ["desgaste del dorado", "peque√±as abolladuras"],
  "dimensiones_estimadas": "Altura: 25 cm, di√°metro: 12 cm",
  "valor_artistico": "alto",
  "observaciones": "Requiere limpieza profesional...",
  "confianza_analisis": "alta"
}
```

---

## üéØ FLUJO COMPLETO DE USO

### **Caso de uso: Catalogar un nuevo objeto**

**PASO 1: Login**
```
Usuario ‚Üí /login
        ‚Üí Supabase Auth
        ‚Üí Redirect a /dashboard
```

**PASO 2: Crear nuevo item**
```
Usuario ‚Üí /inventory/new
        ‚Üí Formulario b√°sico:
           - Nombre
           - N√∫mero de inventario
           - Ubicaci√≥n
```

**PASO 3: Subir im√°genes**
```
Usuario ‚Üí Selecciona archivos
        ‚Üí Upload a Storage:
           bucket: inventario
           path: items/{parish_id}/{item_id}/{timestamp}_{filename}
        ‚Üí INSERT en media:
           - item_id
           - storage_path
           - public_url
           - is_primary = true (primera foto)
```

**PASO 4: An√°lisis con IA (OPCIONAL)**
```
Usuario ‚Üí Click "Analizar con IA"
        ‚Üí POST /api/catalog/analyze
           Body: { 
             imageUrl: media.public_url,
             itemId: items.id 
           }
        ‚Üí Dify API:
           - GPT-4o Mini con visi√≥n
           - Prompt especializado
           - Retorna JSON
        ‚Üí Validaci√≥n Zod
        ‚Üí UPDATE items:
             review_json = {...}
             analyzed_at = NOW()
             status = 'ai_suggested'
        ‚Üí Frontend muestra doble columna
```

**PASO 5: Revisi√≥n y validaci√≥n**
```
Usuario ‚Üí Revisa propuesta IA
        ‚Üí Edita campos si es necesario
        ‚Üí Click "Validar y publicar"
        ‚Üí PUT /api/items/{id}/validate
           Body: { ...campos editados }
        ‚Üí UPDATE items:
             ...campos definitivos
             status = 'validated'
        ‚Üí increment_ai_usage(parish_id)
```

**PASO 6: Objeto en inventario**
```
Usuario ‚Üí /inventory
        ‚Üí Lista de objetos con:
           - Imagen principal
           - Nombre
           - Categor√≠a
           - Estado de conservaci√≥n
        ‚Üí Click en objeto ‚Üí Detalle completo
```

---

## üì± ESTRUCTURA DE PERMISOS

### **Matriz de permisos por rol:**

| Acci√≥n | Admin | User | Viewer |
|--------|-------|------|--------|
| **Ver objetos de su parroquia** | ‚úÖ | ‚úÖ | ‚úÖ |
| **Ver objetos de otras parroquias** | ‚ùå | ‚ùå | ‚ùå |
| **Crear objetos** | ‚úÖ | ‚úÖ | ‚ùå |
| **Editar objetos** | ‚úÖ | ‚úÖ | ‚ùå |
| **Eliminar objetos** | ‚úÖ | ‚ùå | ‚ùå |
| **Subir im√°genes** | ‚úÖ | ‚úÖ | ‚ùå |
| **Eliminar im√°genes** | ‚úÖ | ‚ùå | ‚ùå |
| **Usar an√°lisis IA** | ‚úÖ | ‚úÖ | ‚ùå |
| **Ver estad√≠sticas** | ‚úÖ | ‚úÖ | ‚úÖ |
| **Gestionar usuarios** | ‚úÖ | ‚ùå | ‚ùå |
| **Ver datos de suscripci√≥n** | ‚úÖ | ‚ùå | ‚ùå |
| **Exportar inventario** | ‚úÖ | ‚úÖ | ‚úÖ |

---

## üîë VARIABLES DE ENTORNO NECESARIAS

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGc...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGc... # Solo server-side

# Dify IA
DIFY_API_KEY=app-xxx
DIFY_WORKFLOW_ENDPOINT=https://api.dify.ai/v1/workflows/run

# Stripe (futuro)
STRIPE_SECRET_KEY=sk_test_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_xxx

# App
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

---

## üìà DIAGRAMA ENTIDAD-RELACI√ìN SIMPLIFICADO

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   auth.users    ‚îÇ (Supabase Auth)
‚îÇ  (Autenticaci√≥n)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ 1:1
         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    profiles     ‚îÇ
‚îÇ  - id (PK=FK)   ‚îÇ
‚îÇ  - full_name    ‚îÇ
‚îÇ  - email        ‚îÇ
‚îÇ  - role         ‚îÇ
‚îÇ  - parish_id(FK)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ N:1
         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    parishes     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  subscriptions   ‚îÇ
‚îÇ  - id (PK)      ‚îÇ    1:1    ‚îÇ  - parish_id(FK) ‚îÇ
‚îÇ  - name         ‚îÇ           ‚îÇ  - plan          ‚îÇ
‚îÇ  - diocese      ‚îÇ           ‚îÇ  - max_items     ‚îÇ
‚îÇ  - location     ‚îÇ           ‚îÇ  - ai_limit      ‚îÇ
‚îÇ  - admin_user_id‚îÇ           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ 1:N
         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      items      ‚îÇ
‚îÇ  - id (PK)      ‚îÇ
‚îÇ  - parish_id(FK)‚îÇ
‚îÇ  - created_by(FK)
‚îÇ  - name         ‚îÇ
‚îÇ  - category     ‚îÇ
‚îÇ  - description  ‚îÇ
‚îÇ  - materials[]  ‚îÇ
‚îÇ  - status       ‚îÇ
‚îÇ  - review_json  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ 1:N
         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      media      ‚îÇ
‚îÇ  - id (PK)      ‚îÇ
‚îÇ  - item_id (FK) ‚îÇ
‚îÇ  - storage_path ‚îÇ
‚îÇ  - public_url   ‚îÇ
‚îÇ  - is_primary   ‚îÇ
‚îÇ  - uploaded_by  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéì RESUMEN EJECUTIVO

**Fides Digital** es un SaaS de inventario parroquial que utiliza:

1. **Base de datos relacional** (PostgreSQL/Supabase) con 5 tablas principales
2. **Seguridad multinivel** (RLS) que a√≠sla datos por parroquia
3. **IA para catalogaci√≥n** (GPT-4o Mini) que analiza im√°genes y genera metadatos
4. **Sistema de suscripciones** con l√≠mites por plan (free/basic/premium)
5. **Storage organizado** para archivos multimedia
6. **Funciones custom** que encapsulan l√≥gica de negocio compleja
7. **Vistas optimizadas** para queries frecuentes

**Flujo principal:**
Usuario sube foto ‚Üí IA analiza ‚Üí Usuario valida ‚Üí Objeto catalogado

**Ventaja competitiva:**
Sistema dise√±ado espec√≠ficamente para arte sacro cat√≥lico, con terminolog√≠a especializada y conocimiento del dominio eclesial.

---

*Documento generado para facilitar el entendimiento completo de la arquitectura de Fides Digital por parte de cualquier LLM o desarrollador.*
